@using Krg.Website.Areas.Admin.Models
@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SigninManager;
@model UsersViewModel
@{
    var currentUserId = SigninManager.UserManager.GetUserId(User);
}
<div class="row">
    @{ Html.RenderPartial("CreateUserPartial", new CreateUserDto {Email = string.Empty, Password = string.Empty, RepeatPassword = string.Empty}); }
</div>

<div class="row shadow-sm p-3 mb-5 bg-body rounded">
    <div class="col">
        <h2>Overview</h2>
        <hr/>
        <table class="table table-striped table-sm">
            <thead>
            <tr>
                <th scope="col">Email</th>
                <th scope="col">De-activate</th>
                <th scope="col">Reset password</th>
                <th scope="col">Delete</th>
            </tr>
            </thead>
            <tbody id="users-parent">
            @foreach (var user in Model.Users)
            {
                <tr>
                    <th scope="row">@user.Email</th>
                    <th scope="row">
                        @if (user.LockoutEnabled && user.LockoutEnd != null)
                        {
                            <button class="btn btn-outline-secondary" type="button" onclick="activateUser('@user.Id')">Activate</button>
                        }
                        else
                        {
                            <button class="btn btn-outline-secondary" type="button" onclick="deactivateUser('@user.Id')">Deactivate</button>
                        }
                    </th>
                    <th scope="row"><button class="btn btn-outline-secondary" type="button" onclick="resetPassword('@user.Id')">Reset password</button></th>
                    <th scope="row">
                        @if (currentUserId != user.Id)
                        {
                            <button class="btn btn-outline-secondary" type="button" onclick="deleteUser('@user.Id')">Delete</button>    
                        }
                    </th>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

@section Scripts
{
    <script>        
        function activateUser(id) {
            let data = {
                id: id
            }

            if (confirm('Are you sure?')) {

                console.log('activateUser called for ' + id);

                $.ajax({
                    type: 'POST',
                    url: '/Admin/UsersApi/Activate',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(data),
                    success: function (result) {
                        console.log(result);

                        $('#users-parent').empty();

                        if (result.hasOwnProperty('users')) {
                            updateUsersList(result.users);
                        }
                    }
                });
            }
        }
                
        function deactivateUser(id) {
            let data = {
                id: id
            }

            if (confirm('Are you sure?')) {

                console.log('deactivateUser called for ' + id);

                $.ajax({
                    type: 'POST',
                    url: '/Admin/UsersApi/Deactivate',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(data),
                    success: function (result) {
                        console.log(result);

                        $('#users-parent').empty();

                        if (result.hasOwnProperty('users')) {
                            updateUsersList(result.users);
                        }
                    }
                });
            }
        }
        
        function deleteUser(id) {
            let data = {
                id: id
            }

            if (confirm('Are you sure?')) {

                console.log('deleteUser called for ' + id);
                
                $.ajax({
                    type: 'POST',
                    url: '/Admin/UsersApi/DeleteUser',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(data),
                    success: function (result) {
                        console.log(result);

                        $('#users-parent').empty();

                        if (result.hasOwnProperty('users')) {                       
                            updateUsersList(result.users);
                        }
                    }
                });                
            }
        }

        function updateUsersList(data) {
            let currentUserId = '@SigninManager.UserManager.GetUserId(User)';            
            $.each(data, function (k, v) {
                let userId = v.id;
                let isLockedOut = v.lockoutEnabled === true && v.lockoutEnd !== '' && v.lockoutEnd !== null;
                $('#users-parent')
                    .append(
                        '<tr>' +
                            '<th scope="row">'+ v.email + '</th>' +
                            '<th scope="row">' +
                                (isLockedOut ? 
                                '<button class="btn btn-outline-secondary" type="button" onclick="activateUser(\'' + userId + '\')">Activate</button>' : 
                                '<button type="button" class="btn btn-outline-secondary" onClick="deactivateUser(\'' + userId + '\')">Deactivate</button>'
                                ) +
                            '</th>' +
                            '<th scope="row"><button type="button" class="btn btn-outline-secondary" onClick="resetPassword(\'' + userId + '\')">Reset password</button></th>' +
                            '<th scope="row">' +
                                    (currentUserId !== userId ?
                                    '<button type="button" class="btn btn-outline-secondary" onClick="deleteUser(\'' + userId + '\')">Delete</button>' :
                                    '') +
                            '</th>' + //TODO do not add for current user
                        '</tr>')
            });
        }
        
        function resetPassword(id) {
            let data = {
                Id: id
            }

            if (confirm('Are you sure?')) {

                $.ajax({
                    type: 'POST',
                    url: '/Admin/UsersApi/ResetPassword',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(data),
                    success: function (result) {
                        console.log(result);
                        alert(result.message);                        
                    },
                });
            }
        }
                
        function callApi(url, data) {
            $.ajax({
                type: 'POST',
                url: url,
                contentType: 'application/json; charset=utf-8',
                data: JSON.stringify(data),
                success: function (result) {
                    console.log(result);
                }
            });
        }    
    
    </script>
}